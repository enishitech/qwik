#!/usr/bin/make -f
# -*- makefile -*-
# Sample debian/rules that uses debhelper.
# GNU copyright 1997 to 1999 by Joey Hess.

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

UPSTREAM = qwik
UPSTREAM_VERSION = 0.7.0

CFLAGS = -Wall -g

ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
	CFLAGS += -O0
else
	CFLAGS += -O2
endif
ifeq (,$(findstring nostrip,$(DEB_BUILD_OPTIONS)))
	INSTALL_PROGRAM += -s
endif

build:
	# noting to do

clean:
	dh_testdir
	dh_testroot

	# Clean build and stamps
	rm -rf build
	rm -rf unpack-stamp patch-stamp patch-stampTMP patches-stamp
	-rm -f usr/bin/Makefile ./usr/lib/ruby/1.8/qwik/Makefile ./usr/lib/ruby/1.8/qwik/Makefile
	-rm lib/ext/xmlformatter.o

	dh_clean 

install: build
	dh_testdir
	dh_testroot
	dh_clean -k 
	dh_installdirs

	# Add here commands to install the package into debian/qwik.
	
	#/usr/sbin
	cp -p bin/{quickml-ctl,quickml-server,quickml-message-validator,qwikweb-adduser,qwikweb-backup,qwikweb-catalog-validator,qwikweb-ctl,qwikweb-tempgen,qwikweb-incgen,qwikweb-makesite,qwikweb-server,qwikweb-showpassword,qwikweb-watchlog,watch-alog,watch-ml,watch-qlog,watch-web} $(CURDIR)/debian/qwik/usr/sbin/

	#/usr/lib/ruby/1.8
	install -d $(CURDIR)/debian/qwik/usr/lib/ruby/1.8/qwik

	# qwik lib
	cp -r lib/qwik/*  $(CURDIR)/debian/qwik/usr/lib/ruby/1.8/qwik/
	cd lib/ext/ && ruby1.8 extconf.rb && make 
	install -d $(CURDIR)/debian/qwik/usr/lib/ruby/1.8/$(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)/qwik/
	mv lib/ext/xmlformatter.so $(CURDIR)/debian/qwik/usr/lib/ruby/1.8/$(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)/qwik/
	cd lib/ext/ && make clean && rm Makefile 
	chmod -R 644  $(CURDIR)/debian/qwik/usr/lib/ruby/1.8/qwik/
	
	find $(CURDIR)/debian/qwik/usr/lib/ruby/1.8/qwik/ -type d -print |  xargs chmod 755

	# /usr/share/
	## qwik
	install -d $(CURDIR)/debian/qwik/usr/share/qwik/{super,theme,qrcode,jsunit}
	cp -r lib/super/*  $(CURDIR)/debian/qwik/usr/share/qwik/super/
	cp -r lib/theme/*  $(CURDIR)/debian/qwik/usr/share/qwik/theme/
	cp -r lib/qrcode/* $(CURDIR)/debian/qwik/usr/share/qwik/qrcode/
	cp -r lib/jsunit/* $(CURDIR)/debian/qwik/usr/share/qwik/jsunit/
	chmod -R 644 $(CURDIR)/debian/qwik/usr/share/qwik/
	
	find $(CURDIR)/debian/qwik/usr/share/qwik/ -type d -print |  xargs chmod 755  

	# change path
	perl -i -npe 's!require \"diff\"!require \"algorithm/diff\"!' `find $(CURDIR)/debian/qwik -name '*.rb' -print`
	perl -i -npe 's!/usr/bin/env ruby!/usr/bin/ruby1.8!' `grep -rl \/usr\/bin\/env\ ruby $(CURDIR)/debian/qwik`
	perl -i -npe 's!../log/!/var/log/qwik/!' `find $(CURDIR)/debian/qwik/usr/sbin -name 'watch-*' -print`


	#makeing misc dir
	#qwik
	install -d $(CURDIR)/debian/qwik/var/log/qwik/
	install -d $(CURDIR)/debian/qwik/var/cache/qwik/
	install -d $(CURDIR)/debian/qwik/var/cache/qwik/grave/
	install -d $(CURDIR)/debian/qwik/etc/qwik/
	install -d $(CURDIR)/debian/qwik/etc/qwik/template/
	install -d $(CURDIR)/debian/qwik/var/lib/qwik/data/www/
	install -d $(CURDIR)/debian/qwik/var/lib/qwik/backup/
	install -d $(CURDIR)/debian/qwik/var/run/qwik/
	cp data/www/* $(CURDIR)/debian/qwik/var/lib/qwik/data/www/

	## /etc/qwik/
	# qwik config
	cp etc/* $(CURDIR)/debian/qwik/etc/qwik/
	cp -r lib/template/*  $(CURDIR)/debian/qwik/etc/qwik/template/
	touch $(CURDIR)/debian/qwik/etc/qwik/typekey-sitetoken.txt
	touch $(CURDIR)/debian/qwik/etc/qwik/generation.txt
	touch $(CURDIR)/debian/qwik/etc/qwik/password.txt
	touch $(CURDIR)/debian/qwik/etc/qwik/google-maps-api-key.txt
	

# Build architecture-independent files here.
binary-indep: build install
	dh_testdir
	dh_testroot
	dh_installchangelogs 
	dh_installdocs
	dh_installexamples bin/crontab-backup
#	dh_install
#	dh_installdebconf	
	dh_installlogrotate
#	dh_installemacsen
#	dh_installpam
#	dh_installmime
	dh_installinit
	dh_installcron
#	dh_installinfo
	dh_installman
	dh_link usr/sbin/qwikweb-ctl etc/init.d/qwikweb 
	dh_link usr/sbin/quickml-ctl etc/init.d/quickml 
	dh_strip
	dh_compress
	dh_fixperms
#	dh_makeshlibs
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure
